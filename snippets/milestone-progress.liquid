{% comment %}
  Milestone Progress Bar Component
  
  Displays the milestone progress with checkmarks for achieved milestones.
  Should be rendered in cart drawer/page after the header.
  
  Usage: {% render 'milestone-progress', cart_total: cart.total_price %}
{% endcomment %}

{% comment %} Load milestone configuration first - must be outside liquid block {% endcomment %}
{% render 'milestone-config' %}

{% liquid
  comment
    Calculate eligible cart total (excluding free items)
    For now, we'll use the full cart total. Later we'll filter out free items.
  endcomment
  assign eligible_cart_total = cart.total_price
  
  comment
    Determine which milestones are achieved
  endcomment
  assign milestone_1_achieved = false
  assign milestone_2_achieved = false
  assign milestone_3_achieved = false
  assign milestone_4_achieved = false
  assign milestone_5_achieved = false
  
  if eligible_cart_total >= milestone_1_threshold
    assign milestone_1_achieved = true
  endif
  if eligible_cart_total >= milestone_2_threshold
    assign milestone_2_achieved = true
  endif
  if eligible_cart_total >= milestone_3_threshold
    assign milestone_3_achieved = true
  endif
  if eligible_cart_total >= milestone_4_threshold
    assign milestone_4_achieved = true
  endif
  if eligible_cart_total >= milestone_5_threshold
    assign milestone_5_achieved = true
  endif
  
  comment
    Check if any milestone was just achieved (for success banner)
  endcomment
  assign show_success_banner = false
  if milestone_1_achieved or milestone_2_achieved or milestone_3_achieved or milestone_4_achieved or milestone_5_achieved
    if milestone_show_banner
      assign show_success_banner = true
    endif
  endif
%}

{% comment %} Always show if variables exist, default to true if they don't {% endcomment %}
{% if milestone_rewards_enabled == blank %}
  {% assign milestone_rewards_enabled = true %}
{% endif %}
{% if milestone_show_progress == blank %}
  {% assign milestone_show_progress = true %}
{% endif %}

{% if milestone_rewards_enabled and milestone_show_progress %}
  <div class="milestone-progress" data-milestone-progress>
    {% if show_success_banner %}
      <div class="milestone-progress__banner">
        <p class="milestone-progress__banner-text">
          You have successfully reached the milestone
        </p>
      </div>
    {% endif %}
    
    <div class="milestone-progress__bar">
      <div class="milestone-progress__milestones">
        {% comment %} Milestone 1 {% endcomment %}
        <div class="milestone-progress__milestone {% if milestone_1_achieved %}milestone-progress__milestone--achieved{% endif %}" data-milestone="1">
          <div class="milestone-progress__milestone-threshold">
            {{ milestone_1_threshold | money }}
          </div>
          <div class="milestone-progress__milestone-reward">
            {% if milestone_1_achieved %}
              <span class="milestone-progress__checkmark">✓</span>
            {% endif %}
            {{ milestone_1_display_name }}
          </div>
        </div>
        
        {% comment %} Milestone 2 {% endcomment %}
        <div class="milestone-progress__milestone {% if milestone_2_achieved %}milestone-progress__milestone--achieved{% endif %}" data-milestone="2">
          <div class="milestone-progress__milestone-threshold">
            {{ milestone_2_threshold | money }}
          </div>
          <div class="milestone-progress__milestone-reward">
            {% if milestone_2_achieved %}
              <span class="milestone-progress__checkmark">✓</span>
            {% endif %}
            {{ milestone_2_display_name }}
          </div>
        </div>
        
        {% comment %} Milestone 3 {% endcomment %}
        <div class="milestone-progress__milestone {% if milestone_3_achieved %}milestone-progress__milestone--achieved{% endif %}" data-milestone="3">
          <div class="milestone-progress__milestone-threshold">
            {{ milestone_3_threshold | money }}
          </div>
          <div class="milestone-progress__milestone-reward">
            {% if milestone_3_achieved %}
              <span class="milestone-progress__checkmark">✓</span>
            {% endif %}
            {{ milestone_3_display_name }}
          </div>
        </div>
        
        {% comment %} Milestone 4 {% endcomment %}
        <div class="milestone-progress__milestone {% if milestone_4_achieved %}milestone-progress__milestone--achieved{% endif %}" data-milestone="4">
          <div class="milestone-progress__milestone-threshold">
            {{ milestone_4_threshold | money }}
          </div>
          <div class="milestone-progress__milestone-reward">
            {% if milestone_4_achieved %}
              <span class="milestone-progress__checkmark">✓</span>
            {% endif %}
            {{ milestone_4_display_name }}
          </div>
        </div>
        
        {% comment %} Milestone 5 {% endcomment %}
        <div class="milestone-progress__milestone {% if milestone_5_achieved %}milestone-progress__milestone--achieved{% endif %}" data-milestone="5">
          <div class="milestone-progress__milestone-threshold">
            {{ milestone_5_threshold | money }}
          </div>
          <div class="milestone-progress__milestone-reward">
            {% if milestone_5_achieved %}
              <span class="milestone-progress__checkmark">✓</span>
            {% endif %}
            {{ milestone_5_display_name }}
          </div>
        </div>
      </div>
    </div>
  </div>

<style>
    .milestone-progress {
      padding: 16px;
      background-color: var(--color-background, #fff);
      border-bottom: 1px solid var(--color-border, #e0e0e0);
    }
    
    .milestone-progress__banner {
      background-color: #d4edda;
      border: 1px solid #c3e6cb;
      border-radius: 6px;
      padding: 12px 16px;
      margin-bottom: 16px;
      text-align: center;
    }
    
    .milestone-progress__banner-text {
      margin: 0;
      color: #155724;
      font-size: 14px;
      font-weight: 500;
    }
    
    .milestone-progress__bar {
      width: 100%;
    }
    
    .milestone-progress__milestones {
      display: flex;
      flex-wrap: nowrap;
      gap: 8px;
      align-items: flex-start;
      overflow-x: auto;
      padding-bottom: 4px;
      -webkit-overflow-scrolling: touch;
    }
    
    .milestone-progress__milestones::-webkit-scrollbar {
      height: 4px;
    }
    
    .milestone-progress__milestones::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 2px;
    }
    
    .milestone-progress__milestones::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 2px;
    }
    
    .milestone-progress__milestone {
      flex: 0 0 auto;
      min-width: 80px;
      padding: 10px 8px;
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      text-align: center;
      transition: all 0.3s ease;
      position: relative;
    }
    
    .milestone-progress__milestone--achieved {
      background-color: #d4edda;
      border-color: #28a745;
      box-shadow: 0 2px 4px rgba(40, 167, 69, 0.2);
    }
    
    .milestone-progress__milestone-threshold {
      font-size: 11px;
      font-weight: 600;
      color: #6c757d;
      margin-bottom: 6px;
      line-height: 1.2;
    }
    
    .milestone-progress__milestone--achieved .milestone-progress__milestone-threshold {
      color: #155724;
    }
    
    .milestone-progress__milestone-reward {
      font-size: 10px;
      color: #495057;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      line-height: 1.3;
    }
    
    .milestone-progress__milestone--achieved .milestone-progress__milestone-reward {
      color: #155724;
      font-weight: 500;
    }
    
    .milestone-progress__checkmark {
      color: #28a745;
      font-weight: bold;
      font-size: 12px;
      margin-right: 2px;
    }
    
    @media screen and (max-width: 749px) {
      .milestone-progress {
        padding: 12px;
      }
      
      .milestone-progress__milestones {
        gap: 6px;
      }
      
      .milestone-progress__milestone {
        min-width: 70px;
        padding: 8px 6px;
      }
      
      .milestone-progress__milestone-threshold {
        font-size: 10px;
      }
      
      .milestone-progress__milestone-reward {
        font-size: 9px;
      }
    }
  </style>
{% endif %}

