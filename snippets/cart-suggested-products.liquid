{% comment %}
  Cart Suggested Products Section
  Displays cross-sell products based on collection-based rules
  
  Collections expected:
  - "Whey Protein" (handle: whey-protein)
  - "Essentials" (handle: essentials)
  - "Pre-workout" (handle: pre-workout)
  
  Products must have tag: "best-offer"
{% endcomment %}

{% liquid
  assign cart_collection_handles = blank
  
  for item in cart.items
    if item.product and item.product.collections
      for collection in item.product.collections
        assign cart_collection_handles = cart_collection_handles | append: collection.handle | append: ','
      endfor
    endif
  endfor
  
  assign cart_collections_array = cart_collection_handles | split: ','
  
  assign has_whey_protein = false
  assign has_pre_workout = false
  assign has_essentials = false
  
  for collection_handle in cart_collections_array
    if collection_handle == blank
      continue
    endif
    assign handle_lower = collection_handle | downcase | strip
    assign handle_normalized = handle_lower | replace: ' ', '-' | replace: '_', '-'
    
    if handle_normalized == 'whey-protein' or handle_lower contains 'whey' and handle_lower contains 'protein'
      assign has_whey_protein = true
    elsif handle_normalized == 'pre-workout' or handle_lower contains 'pre' and handle_lower contains 'workout'
      assign has_pre_workout = true
    elsif handle_normalized == 'essentials' or handle_lower == 'essentials'
      assign has_essentials = true
    endif
  endfor
  
  assign collections_to_show = blank
  
  if has_whey_protein
    assign collections_to_show = collections_to_show | append: 'essentials,'
    assign collections_to_show = collections_to_show | append: 'pre-workout,'
  endif
  
  if has_pre_workout
    assign collections_to_show = collections_to_show | append: 'whey-protein,'
  endif
  
  if has_essentials
    assign collections_to_show = collections_to_show | append: 'whey-protein,'
  endif
  
  assign collections_array = collections_to_show | split: ',' | uniq
  
  assign cart_product_ids = blank
  for item in cart.items
    if item.product and item.product.id
      assign cart_product_ids = cart_product_ids | append: item.product.id | append: ','
    endif
  endfor
  assign cart_product_ids_array = cart_product_ids | split: ','
  
  assign product_count = 0
  assign max_products = 6
  assign seen_product_ids = blank
%}

<div class="cart-suggested-products" data-cart-suggested-products>
  {% if collections_array.size > 0 %}
    {% capture suggested_products_html %}
      {% for collection_handle in collections_array %}
        {% if collection_handle == blank %}
          {% continue %}
        {% endif %}
        
        {% if product_count >= max_products %}
          {% break %}
        {% endif %}
        
        {% assign target_collection = collections[collection_handle] %}
        {% if target_collection == blank or target_collection.products == blank %}
          {% continue %}
        {% endif %}
        
        {% for product in target_collection.products limit: 50 %}
          {% if product_count >= max_products %}
            {% break %}
          {% endif %}
          
          {% assign product_id_string = product.id | append: '' %}
          {% assign is_in_cart = false %}
          {% for cart_product_id in cart_product_ids_array %}
            {% if cart_product_id == product_id_string %}
              {% assign is_in_cart = true %}
              {% break %}
            {% endif %}
          {% endfor %}
          
          {% if is_in_cart %}
            {% continue %}
          {% endif %}
          
          {% assign has_best_offer_tag = false %}
          {% if product.tags %}
            {% for tag in product.tags %}
              {% assign tag_lower = tag | downcase %}
              {% if tag_lower == 'best-offer' or tag_lower == 'best offer' or tag_lower == 'best_offer' %}
                {% assign has_best_offer_tag = true %}
                {% break %}
              {% endif %}
            {% endfor %}
          {% endif %}
          
          {% if has_best_offer_tag %}
            {% assign product_id_check = product.id | append: '' %}
            {% assign already_seen = false %}
            {% assign seen_ids_array = seen_product_ids | split: '|' %}
            {% for seen_id in seen_ids_array %}
              {% if seen_id == product_id_check %}
                {% assign already_seen = true %}
                {% break %}
              {% endif %}
            {% endfor %}
            
            {% unless already_seen %}
              {% render 'cart-suggested-product-item', product: product %}
              {% assign seen_product_ids = seen_product_ids | append: product.id | append: '|' %}
              {% assign product_count = product_count | plus: 1 %}
            {% endunless %}
          {% endif %}
        {% endfor %}
      {% endfor %}
    {% endcapture %}
    
    {% if product_count > 0 %}
      <div class="cart-suggested-products__header">
        <h3 class="cart-suggested-products__title h5">Best Offers</h3>
      </div>
      
      <div class="cart-suggested-products__list" data-suggested-products-list>
        {{ suggested_products_html }}
      </div>
    {% endif %}
  {% endif %}
</div>

